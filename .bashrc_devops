#!/bin/bash
# =====================================================
# DevOps Terminal Configuration
# Compatible: Windows (Git Bash), macOS, Linux
# =====================================================

# ============= GIT ALIASES =============
alias gs='git status'
alias ga='git add'
alias gaa='git add .'
alias gc='git commit -m'
alias gca='git commit --amend'
alias gp='git push'
alias gpl='git pull'
alias gl='git log --oneline --graph --decorate --all'
alias gco='git checkout'
alias gcb='git checkout -b'
alias gb='git branch'
alias gbd='git branch -d'
alias gm='git merge'
alias gr='git rebase'
alias gst='git stash'
alias gstp='git stash pop'
alias gd='git diff'
alias gdc='git diff --cached'
alias grh='git reset --hard'
alias grs='git reset --soft HEAD~1'

# Modern git switch (recommended over checkout)
alias gsw='git switch'
alias gswt='git switch -t'

# Branch management
alias gba='git branch -a'
alias gbD='git branch -D'

# Fetch & Push
alias gfa='git fetch --all --prune'
alias gpf='git push --force-with-lease'
alias gpu='git push -u origin'

# Commit advanced
alias gcn='git commit --amend --no-edit'
alias gcp='git cherry-pick'

# Info & Debug
alias grv='git remote -v'
alias gsh='git show'
alias grl='git reflog'
alias gt='git tag'
alias gtl='git tag -l'

# Rebase
alias grbi='git rebase -i'
alias grba='git rebase --abort'
alias grbc='git rebase --continue'

# ============= DOCKER ALIASES =============
alias d='docker'
alias dc='docker-compose'
alias dps='docker ps'
alias dpsa='docker ps -a'
alias di='docker images'
alias dex='docker exec -it'
alias dl='docker logs -f'
alias dsp='docker system prune -af'
alias dvp='docker volume prune -f'
alias drm='docker rm -f'
alias drmi='docker rmi'
alias dcu='docker-compose up -d'
alias dcd='docker-compose down'
alias dcl='docker-compose logs -f'
alias dcr='docker-compose restart'
alias dcp='docker-compose ps'

# ============= KUBERNETES ALIASES =============
alias k='kubectl'
alias kgp='kubectl get pods'
alias kgs='kubectl get services'
alias kgd='kubectl get deployments'
alias kgn='kubectl get nodes'
alias kd='kubectl describe'
alias kl='kubectl logs -f'
alias kex='kubectl exec -it'
alias ka='kubectl apply -f'
alias kdel='kubectl delete'
alias kctx='kubectl config get-contexts'
alias kns='kubectl config set-context --current --namespace'

# ============= TERRAFORM ALIASES =============
alias tf='terraform'
alias tfi='terraform init'
alias tfp='terraform plan'
alias tfa='terraform apply'
alias tfaa='terraform apply -auto-approve'
alias tfd='terraform destroy'
alias tfda='terraform destroy -auto-approve'
alias tff='terraform fmt'
alias tfv='terraform validate'
alias tfs='terraform show'
alias tfo='terraform output'
alias tfr='terraform refresh'

# State management
alias tfsl='terraform state list'
alias tfss='terraform state show'
alias tfsm='terraform state mv'
alias tfsrm='terraform state rm'

# Workspace management
alias tfw='terraform workspace'
alias tfwl='terraform workspace list'
alias tfws='terraform workspace select'
alias tfwn='terraform workspace new'
alias tfwd='terraform workspace delete'

# Advanced
alias tfg='terraform graph'
alias tfc='terraform console'
alias tft='terraform taint'
alias tfu='terraform untaint'
alias tfim='terraform import'

# ============= SYSTEM ALIASES =============
alias ll='ls -lah'
alias la='ls -A'
alias l='ls -CF'
alias ..='cd ..'
alias ...='cd ../..'
alias ....='cd ../../..'
alias c='clear'
alias h='history'
alias path='echo -e ${PATH//:/\\n}'
alias reload='source ~/.bashrc'

# OS-specific commands
if [[ "$OSTYPE" == "msys" || "$OSTYPE" == "win32" ]]; then
    alias open='explorer'
    alias pbcopy='clip'
    export OS_TYPE="windows"
elif [[ "$OSTYPE" == "darwin"* ]]; then
    alias ls='ls -G'
    export OS_TYPE="macos"
else
    alias ls='ls --color=auto'
    export OS_TYPE="linux"
fi

# ============= CORE FUNCTIONS =============

mkcd() {
    mkdir -p "$1" && cd "$1"
}

hg() {
    history | grep "$1"
}

psgrep() {
    ps aux | grep -v grep | grep -i -e VSZ -e "$1"
}

ports() {
    if [[ "$OS_TYPE" == "windows" ]]; then
        netstat -ano | findstr LISTENING
    else
        lsof -i -P -n | grep LISTEN
    fi
}

dclean() {
    echo "[*] Cleaning Docker..."
    docker system prune -af --volumes
    echo "[+] Done"
}

dports() {
    docker ps --format "table {{.Names}}\t{{.Ports}}\t{{.Status}}"
}

dbash() {
    docker exec -it "$1" /bin/bash 2>/dev/null || docker exec -it "$1" /bin/sh
}

gcm() {
    git add .
    git commit -m "$1"
    git push
}

gnb() {
    git checkout -b "$1"
    git push -u origin "$1"
}

gup() {
    CURRENT_BRANCH=$(git branch --show-current)
    MAIN_BRANCH=$(git remote show origin | grep 'HEAD branch' | cut -d' ' -f5)
    
    echo "[*] Updating from $MAIN_BRANCH..."
    git checkout "$MAIN_BRANCH"
    git pull
    git checkout "$CURRENT_BRANCH"
    git merge "$MAIN_BRANCH"
}

dsize() {
    du -sh */ 2>/dev/null | sort -h
}

# ============= PROMPT CONFIGURATION =============

parse_git_branch() {
    git branch 2> /dev/null | sed -e '/^[^*]/d' -e 's/* \(.*\)/(\1)/'
}

RED='\[\033[0;31m\]'
GREEN='\[\033[0;32m\]'
YELLOW='\[\033[0;33m\]'
BLUE='\[\033[0;34m\]'
CYAN='\[\033[0;36m\]'
RESET='\[\033[0m\]'

export PS1="${GREEN}\u${RESET}@${BLUE}\h${RESET}:${CYAN}\w${YELLOW}\$(parse_git_branch)${RESET}\$ "

# ============= ENVIRONMENT VARIABLES =============

export EDITOR='vim'
export VISUAL='vim'
export HISTSIZE=10000
export HISTFILESIZE=20000
export HISTCONTROL=ignoredups:erasedups

# ============= LOAD ADDITIONAL FUNCTIONS =============

if [ -f ~/.bashrc_functions ]; then
    source ~/.bashrc_functions
fi

# ============= HELP SYSTEM =============

aliases() {
    echo ""
    echo "=== GIT ALIASES ==="
    alias | grep "git" | sed 's/alias /  /'
    echo ""
    echo "=== DOCKER ALIASES ==="
    alias | grep "docker" | sed 's/alias /  /'
    echo ""
    echo "=== KUBERNETES ALIASES ==="
    alias | grep "kubectl" | sed 's/alias /  /'
    echo ""
    echo "=== TERRAFORM ALIASES ==="
    alias | grep "terraform\|^tf" | sed 's/alias /  /'
    echo ""
    echo "=== SYSTEM ALIASES ==="
    alias | grep -E "^alias (ll|la|l|cd|c|h|path|reload)=" | sed 's/alias /  /'
    echo ""
    echo "=== CORE FUNCTIONS ==="
    echo "  mkcd <dir>     - Create and enter directory"
    echo "  hg <term>      - Search in history"
    echo "  psgrep <term>  - Search process"
    echo "  ports          - Show listening ports"
    echo "  dclean         - Clean Docker completely"
    echo "  dports         - Show container ports"
    echo "  dbash <name>   - Enter container shell"
    echo "  gcm <msg>      - Git add + commit + push"
    echo "  gnb <name>     - Create and push branch"
    echo "  gup            - Update from main/master"
    echo "  dsize          - Directory sizes"
    echo ""
}

help() {
    local category="${1:-}"
    
    if [ -z "$category" ]; then
        echo ""
        echo "======================================"
        echo "           HELP MENU"
        echo "======================================"
        echo ""
        echo "Usage: help <category>"
        echo ""
        echo "Available categories:"
        echo "  * help git          - Git commands"
        echo "  * help docker       - Docker commands"
        echo "  * help kubernetes   - Kubernetes commands"
        echo "  * help terraform    - Terraform commands"
        echo "  * help system       - System commands"
        echo "  * help functions    - Utility functions"
        echo "  * help all          - Show everything"
        echo ""
        return 0
    fi
    
    case "$category" in
        git)
            echo ""
            echo "======================================"
            echo "           GIT COMMANDS"
            echo "======================================"
            echo ""
            echo "[STATUS & INFO]"
            echo "  gs              - git status"
            echo "  gl              - git log (graph)"
            echo "  gb              - git branch"
            echo "  gba             - git branch -a (all branches)"
            echo "  gd              - git diff"
            echo "  gdc             - git diff --cached"
            echo "  gsh             - git show (last commit)"
            echo "  grl             - git reflog (recover commits)"
            echo "  grv             - git remote -v (show remotes)"
            echo ""
            echo "[COMMIT & PUSH]"
            echo "  ga <file>       - git add <file>"
            echo "  gaa             - git add ."
            echo "  gc 'msg'        - git commit -m 'msg'"
            echo "  gca             - git commit --amend"
            echo "  gcn             - git commit --amend --no-edit"
            echo "  gcm 'msg'       - add + commit + push"
            echo ""
            echo "[SYNC]"
            echo "  gp              - git push"
            echo "  gpu             - git push -u origin (push + track)"
            echo "  gpf             - git push --force-with-lease (safe force)"
            echo "  gpl             - git pull"
            echo "  gfa             - git fetch --all --prune"
            echo "  gup             - update from main/master"
            echo ""
            echo "[BRANCHES (modern switch)]"
            echo "  gsw <branch>    - git switch (modern)"
            echo "  gswt <branch>   - git switch -t (track remote)"
            echo "  gco <branch>    - git checkout (legacy)"
            echo "  gcb <branch>    - create branch"
            echo "  gnb <branch>    - create + push branch"
            echo "  gbd <branch>    - delete branch"
            echo "  gbD <branch>    - force delete branch"
            echo "  gm <branch>     - git merge"
            echo ""
            echo "[CHERRY-PICK & TAGS]"
            echo "  gcp <commit>    - git cherry-pick"
            echo "  gt              - git tag"
            echo "  gtl             - git tag -l (list tags)"
            echo ""
            echo "[STASH]"
            echo "  gst             - git stash"
            echo "  gstp            - git stash pop"
            echo ""
            echo "[REBASE]"
            echo "  gr              - git rebase"
            echo "  grbi            - git rebase -i (interactive)"
            echo "  grba            - git rebase --abort"
            echo "  grbc            - git rebase --continue"
            echo ""
            echo "[RESET]"
            echo "  grh             - git reset --hard"
            echo "  grs             - git reset --soft HEAD~1"
            echo ""
            echo "[FUNCTIONS]"
            echo "  git-cleanup     - clean obsolete branches"
            echo "  git-sync        - sync all branches"
            echo ""
            ;;
            
        docker)
            echo ""
            echo "======================================"
            echo "          DOCKER COMMANDS"
            echo "======================================"
            echo ""
            echo "[INFO]"
            echo "  d               - docker"
            echo "  dps             - docker ps"
            echo "  dpsa            - docker ps -a"
            echo "  di              - docker images"
            echo "  dports          - show container ports"
            echo ""
            echo "[CONTAINERS]"
            echo "  dex <name>      - docker exec -it"
            echo "  dbash <name>    - enter container shell"
            echo "  dl <name>       - docker logs -f"
            echo "  drm <name>      - docker rm -f"
            echo ""
            echo "[IMAGES]"
            echo "  drmi <image>    - docker rmi"
            echo ""
            echo "[CLEANUP]"
            echo "  dsp             - docker system prune -af"
            echo "  dvp             - docker volume prune -f"
            echo "  dclean          - complete cleanup"
            echo ""
            echo "[COMPOSE]"
            echo "  dc              - docker-compose"
            echo "  dcu             - docker-compose up -d"
            echo "  dcd             - docker-compose down"
            echo "  dcl             - docker-compose logs -f"
            echo "  dcr <service>   - docker-compose restart"
            echo "  dcp             - docker-compose ps"
            echo ""
            echo "[ADVANCED]"
            echo "  docker-shell <name>   - enter by partial name"
            echo "  docker-ip <name>      - get container IP"
            echo "  docker-stats-live     - live stats"
            echo ""
            ;;
            
        kubernetes|k8s)
            echo ""
            echo "======================================"
            echo "        KUBERNETES COMMANDS"
            echo "======================================"
            echo ""
            echo "[INFO]"
            echo "  k               - kubectl"
            echo "  kgp             - kubectl get pods"
            echo "  kgs             - kubectl get services"
            echo "  kgd             - kubectl get deployments"
            echo "  kgn             - kubectl get nodes"
            echo "  kd <resource>   - kubectl describe"
            echo ""
            echo "[LOGS & EXEC]"
            echo "  kl <pod>        - kubectl logs -f"
            echo "  kex <pod>       - kubectl exec -it"
            echo ""
            echo "[DEPLOYMENT]"
            echo "  ka <file>       - kubectl apply -f"
            echo "  kdel <resource> - kubectl delete"
            echo ""
            echo "[CONFIG]"
            echo "  kctx            - show contexts"
            echo "  kns <namespace> - change namespace"
            echo ""
            ;;

        terraform|tf)
            echo ""
            echo "======================================"
            echo "        TERRAFORM COMMANDS"
            echo "======================================"
            echo ""
            echo "[INITIALIZATION & PLANNING]"
            echo "  tf              - terraform"
            echo "  tfi             - terraform init"
            echo "  tfp             - terraform plan"
            echo "  tfv             - terraform validate"
            echo "  tff             - terraform fmt (format code)"
            echo ""
            echo "[APPLY & DESTROY]"
            echo "  tfa             - terraform apply"
            echo "  tfaa            - terraform apply -auto-approve"
            echo "  tfd             - terraform destroy"
            echo "  tfda            - terraform destroy -auto-approve"
            echo ""
            echo "[INFO & OUTPUT]"
            echo "  tfs             - terraform show"
            echo "  tfo             - terraform output"
            echo "  tfr             - terraform refresh"
            echo "  tfg             - terraform graph"
            echo "  tfc             - terraform console"
            echo ""
            echo "[STATE MANAGEMENT]"
            echo "  tfsl            - terraform state list"
            echo "  tfss <resource> - terraform state show"
            echo "  tfsm            - terraform state mv"
            echo "  tfsrm           - terraform state rm"
            echo ""
            echo "[WORKSPACE MANAGEMENT]"
            echo "  tfw             - terraform workspace"
            echo "  tfwl            - terraform workspace list"
            echo "  tfws <name>     - terraform workspace select"
            echo "  tfwn <name>     - terraform workspace new"
            echo "  tfwd <name>     - terraform workspace delete"
            echo ""
            echo "[ADVANCED]"
            echo "  tft <resource>  - terraform taint"
            echo "  tfu <resource>  - terraform untaint"
            echo "  tfim            - terraform import"
            echo ""
            echo "[FUNCTIONS]"
            echo "  tf-clean        - clean Terraform cache"
            echo "  tf-check        - validate + format + plan"
            echo "  tf-new          - initialize new Terraform project"
            echo ""
            ;;

        system|sys)
            echo ""
            echo "======================================"
            echo "         SYSTEM COMMANDS"
            echo "======================================"
            echo ""
            echo "[NAVIGATION]"
            echo "  ll              - ls -lah"
            echo "  la              - ls -A"
            echo "  l               - ls -CF"
            echo "  ..              - cd .."
            echo "  ...             - cd ../.."
            echo "  ....            - cd ../../.."
            echo ""
            echo "[UTILITIES]"
            echo "  c               - clear"
            echo "  h               - history"
            echo "  path            - show PATH"
            echo "  reload          - reload config"
            echo "  open <path>     - open in explorer"
            echo ""
            echo "[NETWORK]"
            echo "  ports           - show listening ports"
            echo "  psgrep <term>   - search process"
            echo "  hg <term>       - search history"
            echo ""
            echo "[ADVANCED]"
            echo "  find-port <port>    - find process on port"
            echo "  kill-port <port>    - kill process on port"
            echo ""
            ;;
            
        functions|func|f)
            echo ""
            echo "======================================"
            echo "        UTILITY FUNCTIONS"
            echo "======================================"
            echo ""
            echo "[FILES]"
            echo "  mkcd <dir>              - create and enter directory"
            echo "  dsize                   - show directory sizes"
            echo "  extract <archive>       - extract any archive"
            echo ""
            echo "[SEARCH]"
            echo "  hg <term>               - search in history"
            echo "  psgrep <term>           - search process"
            echo ""
            echo "[NETWORK]"
            echo "  ports                   - show listening ports"
            echo "  find-port <port>        - find process on port"
            echo "  kill-port <port>        - kill process on port"
            echo ""
            echo "[GIT]"
            echo "  gcm 'msg'               - add + commit + push"
            echo "  gnb <branch>            - create + push branch"
            echo "  gup                     - update from main/master"
            echo "  gswt <branch>           - git switch -t (track remote)"
            echo "  gcn                     - amend commit (no edit)"
            echo "  gcp <commit>            - git cherry-pick"
            echo "  git-cleanup             - clean obsolete branches"
            echo "  git-sync                - sync all branches"
            echo ""
            echo "[DOCKER]"
            echo "  dbash <name>            - enter container shell"
            echo "  dports                  - show container ports"
            echo "  dclean                  - complete Docker cleanup"
            echo "  docker-shell <name>     - enter by partial name"
            echo "  docker-ip <name>        - get container IP"
            echo "  docker-stats-live       - live stats"
            echo ""
            echo "[TERRAFORM]"
            echo "  tf-clean                - clean Terraform cache & files"
            echo "  tf-check                - validate + format + plan"
            echo "  tf-new <name>           - create new Terraform project"
            echo "  tf-graph-viz [file]     - generate infrastructure graph"
            echo ""
            echo "[BACKUP]"
            echo "  backup-config           - backup terminal config"
            echo ""
            echo "[UTILITIES]"
            echo "  weather [city]          - show weather"
            echo "  cheat <command>         - show command cheatsheet"
            echo ""
            ;;
            
        all)
            help git
            help docker
            help kubernetes
            help terraform
            help system
            help functions
            ;;

        *)
            echo ""
            echo "[!] Unknown category: $category"
            echo ""
            echo "Available categories:"
            echo "  * help git"
            echo "  * help docker"
            echo "  * help kubernetes"
            echo "  * help terraform"
            echo "  * help system"
            echo "  * help functions"
            echo "  * help all"
            echo ""
            ;;
    esac
}

alias h?='help'
alias aide='help'
